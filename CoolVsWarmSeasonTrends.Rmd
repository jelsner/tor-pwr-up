---
title: "Cool vs warm season trends"
author: "James B. Elsner"
date: September 2022
output: 
  html_document:
    keep_md: true
editor_options: 
  chunk_output_type: console
---

R version 4.2.1 (2022-06-23) -- "Funny-Looking Kid"

Load packages.
```{r}
library(tidyverse)
library(lubridate)
library(ggplot2)
library(sf)
```

Get the data from SPC and import the shapefile.
```{r}
if(!"1950-2019-torn-aspath" %in% list.files()) {
download.file(url = "http://www.spc.noaa.gov/gis/svrgis/zipped/1950-2019-torn-aspath.zip",
              destfile = "1950-2019-torn-aspath.zip")
unzip("1950-2019-torn-aspath.zip")
}

Torn.sf <- st_read(dsn = "1950-2019-torn-aspath", 
                   layer = "1950-2019-torn-aspath")

if(!"1950-2020-torn-inipoint" %in% list.files()) {
download.file(url = "http://www.spc.noaa.gov/gis/svrgis/zipped/1950-2020-torn-initpoint.zip",
              destfile = "1950-2020-torn-initpoint.zip")
unzip("1950-2020-torn-initpoint.zip")
}

Torn.sf <- st_read(dsn = "1950-2020-torn-initpoint", 
                   layer = "1950-2020-torn-initpoint")
```

Prepare the data. Keep only tornadoes since 1994 for Mississippi and/or Oklahoma. The year marks the beginning of comprehensive WSR-88D radar. The two states approximate the areas used in the pseudo-global warming (PGW) experiment.

For missing EF ratings use the modification rules (if/else) defined here: https://www.spc.noaa.gov/wcm/OneTor_F-scale-modifications.pdf
```{r}
Torn_OKwarm.sf <- Torn.sf |>
  filter(yr >= 1994 & yr <= 2020) |>
  filter(st == "OK", mo %in% c(5, 6, 7, 8)) |> 
  mutate(mag = ifelse(mag == -9 & len <= 5, 0, mag),
         mag = ifelse(mag == -9 & len > 5, 1, mag)) |>
  mutate(DateTime = as.POSIXct(paste(yr, mo, dy, time), 
                               format = "%Y%m%d%H:%M:%S"),
         Hour = hour(DateTime),
         Year = year(DateTime),
         Length = len * 1609.34,
         Length = ifelse(Length == 0, min(Length[Length > 0]), Length), #takes care of zero length
         Width = wid * .9144,
         Width = ifelse(Width == 0, min(Width[Width > 0]), Width), #takes care of zero width
         Width = ifelse(Year >= 1995, Width * pi/4, Width), #takes care of change: avg to max
         cas = inj + fat,
         AreaPath = Length * Width,
         Ma = factor(month.abb[mo], levels = month.abb[1:12]))

Torn_MScool.sf <- Torn.sf |>
  filter(yr >= 1994 & yr <= 2020) |>
  filter(st == "MS", mo %in% c(1, 2, 11, 12)) |>
  mutate(mag = ifelse(mag == -9 & len <= 5, 0, mag),
         mag = ifelse(mag == -9 & len > 5, 1, mag)) |>
  mutate(DateTime = as.POSIXct(paste(yr, mo, dy, time), 
                               format = "%Y%m%d%H:%M:%S"),
         Hour = hour(DateTime),
         Year = year(DateTime),
         Length = len * 1609.34,
         Length = ifelse(Length == 0, min(Length[Length > 0]), Length), #takes care of zero length
         Width = wid * .9144,
         Width = ifelse(Width == 0, min(Width[Width > 0]), Width), #takes care of zero width
         Width = ifelse(Year >= 1995, Width * pi/4, Width), #takes care of change: avg to max
         cas = inj + fat,
         AreaPath = Length * Width,
         Ma = factor(month.abb[mo], levels = month.abb[1:12]))
```

Compute per-tornado energy dissipation. Energy dissipation is computed as in Fricker et al. (2017). <https://myweb.fsu.edu/jelsner/PDF/Research/FrickerElsnerJagger2017.pdf>
```{r}
perc <- c(1, 0, 0, 0, 0, 0, 
         .772, .228, 0, 0, 0, 0,
         .616, .268, .115, 0, 0, 0,
         .529, .271, .133, .067, 0, 0,
         .543, .238, .131, .056, .032, 0,
         .538, .223, .119, .07, .033, .017)
percM <- matrix(perc, ncol = 6, byrow = TRUE)
threshW <- c(29.06, 38.45, 49.62, 60.8, 74.21, 89.41)
midptW <- c(diff(threshW)/2 + threshW[-length(threshW)], threshW[length(threshW)] + 7.5)

ef <- Torn_OKwarm.sf$mag + 1
EW3 <- numeric()
for(i in 1:length(ef)) EW3[i] <- midptW^3 %*% percM[ef[i], ]
Torn_OKwarm.sf$e3 <- EW3
Torn_OKwarm.sf$ED <- Torn_OKwarm.sf$e3 * Torn_OKwarm.sf$AreaPath

ef <- Torn_MScool.sf$mag + 1
EW3 <- numeric()
for(i in 1:length(ef)) EW3[i] <- midptW^3 %*% percM[ef[i], ]
Torn_MScool.sf$e3 <- EW3
Torn_MScool.sf$ED <- Torn_MScool.sf$e3 * Torn_MScool.sf$AreaPath
```

```{r}
Torn_OKwarm.sf |>
  st_drop_geometry() |>
  summarize(arithmeticM = mean(ED) / 10^9,
            geometricM = exp(mean(log(ED))) / 10^9,
            harmonicMean = 1/mean(1/ED) / 10^9,
            scalingFactor = arithmeticM / geometricM,
            q25 = quantile(ED, probs = .25) / 10^9,
            q50 = quantile(ED, probs = .5) / 10^9,
            q75 = quantile(ED, probs = .75) / 10^9)
```

```{r}
Torn_MScool.sf |>
  st_drop_geometry() |>
  summarize(arithmeticM = mean(ED) / 10^9,
            geometricM = exp(mean(log(ED))) / 10^9,
            harmonicMean = 1/mean(1/ED) / 10^9,
            scalingFactor = arithmeticM / geometricM,
            q25 = quantile(ED, probs = .25) / 10^9,
            q50 = quantile(ED, probs = .5) / 10^9,
            q75 = quantile(ED, probs = .75) / 10^9)
```

Statistics of energy dissipation by damage rating.
```{r}
Torn_OKwarm.sf |>
  st_drop_geometry() |>
  group_by(mag) |>
  summarize(nT = n(),
            arithmeticM = mean(ED) / 10^9,
            geometricM = exp(mean(log(ED))) / 10^9,
            q25 = quantile(ED, probs = .25) / 10^9,
            q50 = quantile(ED, probs = .5) / 10^9,
            q75 = quantile(ED, probs = .75) / 10^9)
```

```{r}
Torn_MScool.sf |>
  st_drop_geometry() |>
  group_by(mag) |>
  summarize(nT = n(),
            arithmeticM = mean(ED) / 10^9,
            geometricM = exp(mean(log(ED))) / 10^9,
            q25 = quantile(ED, probs = .25) / 10^9,
            q50 = quantile(ED, probs = .5) / 10^9,
            q75 = quantile(ED, probs = .75) / 10^9)
```

Statistics of energy dissipation by hour of day.
```{r}
Torn_OKwarm.sf |>
  st_drop_geometry() |>
  group_by(Hour) |>
  summarize(nT = n(),
            arithmeticMean = mean(ED) / 10^9,
            geometricMean = exp(mean(log(ED))) / 10^9,
            q90 = quantile(ED, probs = .9) / 10^9,
            q75 = quantile(ED, probs = .75) / 10^9) 
```

```{r}
Torn_MScool.sf |>
  st_drop_geometry() |>
  group_by(Hour) |>
  summarize(nT = n(),
            arithmeticMean = mean(ED) / 10^9,
            geometricMean = exp(mean(log(ED))) / 10^9,
            q90 = quantile(ED, probs = .9) / 10^9,
            q75 = quantile(ED, probs = .75) / 10^9) 
```

```{r}
Torn_MScool.sf |>
  filter(yr >= 2007) |>
  group_by(yr) |>
  summarize(nT = n()) |>
  pull(nT) |>
  summary()

Torn_OKwarm.sf |>
  filter(yr >= 2007) |>
  group_by(yr) |>
  summarize(nT = n()) |>
  pull(nT) |>
  summary()
```

Annual quantiles
```{r}
dfOK <-
  Torn_OKwarm.sf |>  
  st_drop_geometry() |>
  group_by(yr) |>
  summarize(nT = n(),
            nST = sum(mag >= 4),
            nC = sum(inj + fat),
            avgED = mean(ED),
            q25ED = quantile(ED, prob = .25),
            q50ED = quantile(ED, prob = .5),
            q75ED = quantile(ED, prob = .75),
            q90ED = quantile(ED, prob = .9),
            q95ED = quantile(ED, prob = .95),
            maxED = max(ED),
            totalED = sum(ED))

dfMS <-
  Torn_MScool.sf |>  
  st_drop_geometry() |>
  group_by(yr) |>
  summarize(nT = n(),
            nST = sum(mag >= 4),
            nC = sum(inj + fat),
            avgED = mean(ED),
            q25ED = quantile(ED, prob = .25),
            q50ED = quantile(ED, prob = .5),
            q75ED = quantile(ED, prob = .75),
            q90ED = quantile(ED, prob = .9),
            q95ED = quantile(ED, prob = .95),
            maxED = max(ED),
            totalED = sum(ED))
```

```{r}
dfOK <- dfOK |>
  mutate(State = "OK warm-season")

dfMS <- dfMS |>
  mutate(State = "MS cool-season")

df <- rbind(dfOK, dfMS)
```

Plot trends
```{r}
df |>
  filter(yr >= 2007) |>
ggplot(mapping = aes(x = yr, y = maxED / 10^9, color = State)) +
  geom_point() +
  scale_color_manual(values = c("blue", "red")) +
  scale_y_log10() +
  geom_smooth(method = lm, se = FALSE) +
  scale_x_continuous(breaks = seq(2007, 2019, by = 3)) +
  labs(x = "Year", y = "Highest tornado intensity (GW)") +
  theme_minimal() +
  theme(legend.title=element_blank())
```

```{r}
ggplot(data = dfOK, 
       mapping = aes(x = yr, y = q50ED/10^9)) +
  geom_errorbar(aes(ymin = q25ED/10^9, ymax = q75ED/10^9), 
                color = "grey", width = .2) +
  geom_point() +
  geom_point(aes(x = yr, y = q90ED/10^9), data = dfOK, color = "red") +
#  scale_y_log10() +
  scale_y_log10(breaks = c(.1, 1, 10, 100, 1000), 
                labels = c(.1, 1, 10, 100, 1000), 
                limits = c(.01, 2500)) +
  scale_x_continuous(breaks = seq(1995, 2020, 5)) +
  xlab("Year") + ylab("Power [GW]") +
  theme_minimal() 

ggplot(data = dfMS, 
       mapping = aes(x = yr, y = q50ED/10^9)) +
  geom_errorbar(aes(ymin = q25ED/10^9, ymax = q75ED/10^9), 
                color = "grey", width = .2) +
  geom_point() +
  geom_point(aes(x = yr, y = q90ED/10^9), data = dfMS, color = "red") +
#  scale_y_log10() +
  scale_y_log10(breaks = c(.1, 1, 10, 100, 1000), 
                labels = c(.1, 1, 10, 100, 1000), 
                limits = c(.01, 2500)) +
  scale_x_continuous(breaks = seq(1995, 2020, 5)) +
  xlab("Year") + ylab("Power [GW]") +
  theme_minimal() 
```

No changes in the number of EF3+ or EF4+ tornadoes in OK and MS.

Annual trend
```{r}
summary(lm(log(maxED) ~ yr, data = dfMS[dfMS$yr >= 2007,]))

summary(lm(log(maxED) ~ yr, weights = nT, data = dfMS[dfMS$yr >= 2007,]))
summary(lm(log(maxED) ~ yr, weights = nT, data = dfOK[dfOK$yr >= 2007,]))


modelMS <- lm(log(maxED) ~ yr, weights = nT, data = dfMS[dfMS$yr >= 2007,])
modelOK <- lm(log(maxED) ~ yr, weights = nT, data = dfOK[dfOK$yr >= 2007,])

lmtest::bptest(modelOK) # H0: residuals are distributed w/ equal variance
```

Quantile regression
```{r}
library(quantreg)

df <- Torn_MScool.sf |>
  filter(yr >= 2007, mag >= 1)

summary(rq(log(ED) ~ yr, tau = .5, 
           data = df))

df <- Torn_OKwarm.sf |>
  filter(yr >= 2007, mag >= 1)

summary(rq(log(ED) ~ yr, tau = .5, 
           data = df))
```

Upward trends in tornado intensity for MS during the cold season and a downward trend in OK during the warm season.